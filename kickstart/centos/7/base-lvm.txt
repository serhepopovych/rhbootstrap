#version=RHEL7

# Istall or upgrade?
install
# Use graphical or text install?
text
## Use NFS as installation source
#nfs --server=203.0.113.1 --dir=/srv/nfs/linux/redhat/centos/7.8/amd64/iso-root
# Use HTTP mirrors as installation source
url --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=x86_64&repo=os
# Add repos during install
repo --name=updates --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=x86_64&repo=updates
repo --name=extras --mirrorlist=http://mirrorlist.centos.org/?release=7&arch=x86_64&repo=extras

# Install on unsupported hardware
unsupported_hardware
# Accept EULA
eula --accepted
# Run the Setup Agent on first boot
firstboot --disable
# Reboot system on finish
reboot

# Keyboard layouts
keyboard us --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# System authorization information
auth --enableshadow --passalgo=sha512
# Root password
rootpw --iscrypted --lock *
# User account
user --name=setup --groups=wheel --gecos="Setup user" --plaintext --password=setup

# System timezone
timezone UTC --utc

# Network information
network --device=link --bootproto=dhcp --ipv6=auto --hostname=localhost.localdomain --no-activate

# System services
services --enabled=chronyd,ipset,iptables,ip6tables

%include /tmp/storage.txt

%packages

@core --nodefaults

-aic94xx-firmware
-alsa*
-ivtv*firmware
-iwl*firmware
-libertas*
#-NetworkManager*
-wpa_supplicant
#-teamd
#-tuned
-firewalld
-plymouth*
-parted
-iprutils
#-kexec-tools
#-xfsprogs

postfix

chrony

rsyslog
logrotate

cronie

sudo
telnet

iptables-services
ipset-service
conntrack-tools

gdisk

mc
tmux

mtr
tcpdump

wget

strace
lsof

%end

#%addon com_redhat_kdump --enable --reserve-mb='auto'
#%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

%pre

device_name='/dev/vda'
if [ ! -b "$device_name" ]; then
    device_name='/dev/xvda'
    if [ ! -b "$device_name" ]; then
        device_name='/dev/sda'
    fi
fi

cat >'/tmp/storage.txt' <<EOF

# Partition clearing information
zerombr
clearpart --drives=$device_name --all --disklabel=gpt

# Disk partitioning information
part biosboot   --fstype="biosboot" --ondisk=$device_name --size=1
part /boot      --fstype="ext2"     --ondisk=$device_name --size=512  --label=BOOT
part /boot/efi  --fstype="efi"      --ondisk=$device_name --size=256  --label=ESP
part pv.1742                        --ondisk=$device_name --size=9216 --maxsize=18432 --grow

# Logical Volume Management (LVM)
volgroup centos pv.1742
logvol /home --vgname=centos --name=home --fstype=ext4 --size=1024 --label=HOME
logvol /var  --vgname=centos --name=var  --fstype=ext4 --size=2048 --label=VAR
logvol /     --vgname=centos --name=root --fstype=ext4 --size=5120 --label=ROOT
logvol swap  --vgname=centos --name=swap --fstype=swap --size=1024 --label=SWAP

# System bootloader configuration
bootloader --append=" crashkernel=auto zswap.enabled=1 nosmt" --location=mbr --boot-drive=$device_name
EOF

%end
